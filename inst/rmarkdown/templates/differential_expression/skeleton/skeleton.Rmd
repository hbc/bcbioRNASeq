---
title: "Differential expression"
author: ""
date: "`r Sys.Date()`"
bibliography: bcbioRnaseq.bib
---

```{r setup, message=FALSE}
library(DESeq2)
library(bcbioRnaseq)

downloads()

source("setup.R") # modify parameters before exec this line

# Significance cutoffs
alpha <- 0.05
lfc <- 1
```

```{r header, child="header.Rmd"}
```


```{r dds-de, results="hide", eval=sum(ls() == "ddsde")==0}
txi <- bcbio(bcb, "tximport")
colData <- colData(bcb)

ddsde <- DESeqDataSetFromTximport(
    txi = txi,
    colData = colData,
    design = design) %>%
    DESeq
rld <- rlog(ddsde)
save_data(ddsde, dir=data_out)
resultsNames(ddsde)
sizeFactors(ddsde)
```

# Alpha level (FDR) cutoffs

Let's take a look at the number of genes we get with different false discovery rate (FDR) cutoffs. These tests subset *P* values that have been multiple test corrected using the Benjamini Hochberg (BH) method [@Benjamini:1995ws].

```{r alpha_summary, results='asis'}
alpha_summary(ddsde, contrast = contrast)
```



# Results

```{r res}
res_unshrunken <- results(
    ddsde,
    contrast = contrast,
    alpha = alpha)

# DESeqResults with shrunken log2 fold changes (LFC).
# Still being prototyped, see `?lfcShrink` (DESeq 1.16).
res_shrunken <- lfcShrink(
    dds = ddsde,
    contrast = contrast,
    res = res_unshrunken)

# Compare these two results and pick which one to report
res <- res_shrunken
save_data(res, res_unshrunken, res_shrunken, dir=data_out)
```

We performed the analysis using a BH adjusted *P* value cutoff of `r alpha` and a log fold-change (LFC) ratio cutoff of `r lfc`.


# Plots

## Mean average (MA)

An MA plot compares transformed counts on `M` (log ratio) and `A` (mean average) scales [@Yang:2002ty].

```{r plot_ma}
plot_ma(res, ylim = 3)
```


## Volcano

A volcano plot compares significance (BH-adjusted *P* value) against fold change (log2) [@Cui:2003kh; @Li:2014fv]. Genes in the green box with text labels have an adjusted *P* value are likely to be the top candidate genes of interest.

```{r plot_volcano}
plot_volcano(bcb, res = res, lfc = lfc)
```


## Heatmap

This plot shows only differentially expressed genes on a per-sample basis. We have scaled the data by row and used the `ward.D2` method for clustering [@WardJr:1963eu].

```{r plot_deg_heatmap}
plot_deg_heatmap(bcb, res = res, dt = rld, lfc = lfc)
```


# File downloads

The results are saved as gzip-compressed comma separated values (CSV). Gzip compression is natively supported on [macOS][] and Linux-based operating systems. If you're running Windows, we recommend installing [7-Zip][]. CSV files can be opened in [Excel][] or [RStudio][].


## Count matrices

- [`normalized_counts.csv.gz`](results/normalized_counts.csv.gz):
    Use to evaluate individual genes and/or generate plots. These counts are
    normalized for the variation in sequencing depth across samples.
- [`tpm.csv.gz`](results/tpm.csv.gz):
    Transcripts per million, scaled by length and also suitable for plotting.
- [`raw_counts.csv.gz`](results/raw_counts.csv.gz):
    Only use to perform a new differential expression analysis. These counts
    will vary across samples due to differences in sequencing depth, and have
    not been normalized. Do not use this file for plotting genes.


## Differentially expressed genes (DEG)

DEG tables are sorted by BH-adjusted P value, and contain the following columns:

- `ensembl_gene_id`: [Ensembl][] gene identifier.
- `base_mean`: Mean of the normalized counts per gene for all samples.
- `log2_fold_change`: log2 fold change.
- `lfc_se`: log2 standard error.
- `stat`: Wald statistic.
- `pvalue`: Walt test *P* value.
- `padj`: BH adjusted Wald test *P* value (corrected for multiple comparisons; FDR).
- `external_gene_name`: [Ensembl][] name (a.k.a. symbol).
- `description`: [Ensembl][] description.
- `gene_biotype`: [Ensembl][] biotype (e.g. `protein_coding`).

```{r res_tbl, results="asis"}
res_tbl <- res_tables(bcb, res = res, lfc = lfc, dir=res_out)
save_data(res_tbl, dir=data_out)
```



# Top tables

Only the top up- and down-regulated genes (arranged by log2 fold change) are shown.

```{r top_tables, results="asis"}
top_tables(res_tbl)
```



```{r footer, child="footer.Rmd"}
```
